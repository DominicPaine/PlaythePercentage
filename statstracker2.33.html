<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Play the Percentage Golf - Advanced Stats Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, doc, getDoc, deleteDoc, writeBatch, serverTimestamp, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBstdRCa1aajnFxxdLv39SvKdn20_SyaA4",
          authDomain: "pga-tour-stats-e863f.firebaseapp.com",
          projectId: "pga-tour-stats-e863f",
          storageBucket: "pga-tour-stats-e863f.firebasestorage.app",
          messagingSenderId: "188591537756",
          appId: "1:188591537756:web:eac9bdbd6dcb440ec8b099",
          measurementId: "G-03GPM5ZNH0"
        };
        const firestorePathIdentifier = firebaseConfig.projectId; 
        
        let app; let auth; let db; let analytics; 
        let currentUserId = null;
        let chartInstances = {}; 

        const appState = {
            roundData: null, currentHoleData: null, currentShotNumber: 1,
            currentShotStartLie: 'tee', currentShotStartDistance: 0,
            currentHoleTotalStrokes: 0, currentHolePenalties: 0, currentHoleNumber: 1,
            knownCourses: {}
        };

        const LOCAL_STORAGE_KEY = 'playPercentageGolfSession';

        // --- UI Elements ---
        const pageDashboard = document.getElementById('pageDashboard');
        const pageDataEntry = document.getElementById('pageDataEntry');
        const navLinkDashboard = document.getElementById('navLinkDashboard');
        const navLinkDataEntry = document.getElementById('navLinkDataEntry');
        const initialRoundSetupForm = document.getElementById('initialRoundSetupForm');
        const courseNameInput = document.getElementById('roundCourseName');
        const courseDatalist = document.getElementById('course-list');
        const holeSetupSection = document.getElementById('holeSetupSection');
        const shotEntrySection = document.getElementById('shotEntrySection');
        const holeInfoForm = document.getElementById('holeInfoForm');
        const shotDataForm = document.getElementById('shotDataForm');
        const currentHoleNumberDisplay = document.getElementById('currentHoleNumberDisplay');
        const currentHoleNumberDisplayClone = document.getElementById('currentHoleNumberDisplayClone'); 
        const currentShotNumberDisplay = document.getElementById('currentShotNumberDisplay');
        const currentShotStartLieDisplay = document.getElementById('currentShotStartLieDisplay');
        const currentShotStartDistanceDisplay = document.getElementById('currentShotStartDistanceDisplay');
        const finishHoleButton = document.getElementById('finishHoleButton');
        const finishRoundButton = document.getElementById('finishRoundButton');
        const roundsTableBody = document.getElementById('roundsTableBody');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const messageModal = document.getElementById('messageModal');
        const messageText = document.getElementById('messageText');
        const closeMessageModalButton = document.getElementById('closeMessageModalButton');
        const resumeSessionModal = document.getElementById('resumeSessionModal');
        const resumeSessionButton = document.getElementById('resumeSessionButton');
        const discardSessionButton = document.getElementById('discardSessionButton');
        const statsSummary = document.getElementById('statsSummary');

        // --- NEW, IMPROVED DATA MODEL (Based on Scratch Golfer Benchmarks) ---
        const expectedStrokesData = {
            tee: {
                3: { '100': 2.85, '125': 2.92, '150': 3.00, '175': 3.08, '200': 3.15, '225': 3.25, '250': 3.35 },
                4: { '300': 3.85, '350': 3.98, '400': 4.12, '450': 4.28, '500': 4.45 },
                5: { '450': 4.55, '500': 4.70, '550': 4.85, '600': 5.00 }
            },
            fairway: { 10: 1.85, 20: 2.05, 30: 2.20, 40: 2.35, 50: 2.50, 60: 2.60, 70: 2.70, 80: 2.78, 90: 2.84, 100: 2.89, 125: 3.02, 150: 3.18, 175: 3.37, 200: 3.57, 225: 3.70, 250: 3.82, 275: 3.95, 300: 4.05 },
            rough: { 10: 2.00, 20: 2.22, 30: 2.40, 40: 2.55, 50: 2.68, 60: 2.78, 70: 2.88, 80: 2.95, 90: 3.02, 100: 3.10, 125: 3.29, 150: 3.53, 175: 3.75, 200: 3.98, 225: 4.15, 250: 4.30 },
            fairwayBunker: { 50: 2.75, 75: 2.95, 100: 3.15, 125: 3.35, 150: 3.60, 175: 3.85, 200: 4.10, 225: 4.30 },
            greensideBunker: { 5: 2.10, 10: 2.20, 15: 2.30, 20: 2.40, 25: 2.50, 30: 2.60, 40: 2.70, 50: 2.80 },
            recovery: { 50: 2.90, 75: 3.10, 100: 3.30, 125: 3.50, 150: 3.70, 175: 3.95, 200: 4.20 },
            fringe: { 1: 1.05, 3: 1.10, 6: 1.20, 9: 1.30, 12: 1.40, 15: 1.50, 20: 1.60, 25: 1.70, 30: 1.80, 40: 1.90, 50: 2.00, 60: 2.10 },
            putting: { 1: 1.00, 2: 1.01, 3: 1.04, 4: 1.10, 5: 1.18, 6: 1.27, 7: 1.36, 8: 1.44, 9: 1.52, 10: 1.59, 11: 1.65, 12: 1.70, 13: 1.74, 14: 1.78, 15: 1.82, 18: 1.91, 20: 1.95, 25: 2.05, 30: 2.13, 35: 2.21, 40: 2.28, 50: 2.41, 60: 2.52 }
        };
        
        function interpolate(x, x0, y0, x1, y1) { if (x1 === x0) return y0; return y0 + (x - x0) * (y1 - y0) / (x1 - x0); }

        function getExpectedStrokes(distance, lie, isTeeShot = false, holePar = null, holeLength = null) {
            lie = lie.toLowerCase();
            let dataTable;
            if (isTeeShot) {
                if (!holePar || !expectedStrokesData.tee[holePar] || holeLength === null) return 4.12; 
                dataTable = expectedStrokesData.tee[holePar];
                distance = holeLength;
            } else if (lie === 'putting' || lie === 'green') {
                dataTable = expectedStrokesData.putting;
            } else {
                dataTable = expectedStrokesData[lie];
                if (!dataTable) {
                     console.warn(`No data table for lie: ${lie}. Using 'recovery' as fallback.`);
                     dataTable = expectedStrokesData.recovery;
                }
            }
            const keys = Object.keys(dataTable).map(Number).sort((a,b) => a - b);
            if (distance <= keys[0]) return dataTable[keys[0]];
            if (distance >= keys[keys.length - 1]) return dataTable[keys[keys.length - 1]];
            let i = 1;
            while(keys[i] < distance) i++;
            return interpolate(distance, keys[i-1], dataTable[keys[i-1]], keys[i], dataTable[keys[i]]);
        }
        
        // --- Session Management ---
        function saveStateToLocalStorage() { try { if (appState.roundData) { localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(appState)); } } catch (e) { console.error("Error saving state", e); } }
        function loadStateFromLocalStorage() { try { const savedStateJSON = localStorage.getItem(LOCAL_STORAGE_KEY); if (savedStateJSON) { const savedState = JSON.parse(savedStateJSON); Object.assign(appState, savedState); return true; } return false; } catch (e) { console.error("Error loading state", e); clearStateFromLocalStorage(); return false; } }
        function clearStateFromLocalStorage() { localStorage.removeItem(LOCAL_STORAGE_KEY); }

        // --- Core Functions ---
        function showMessage(message, isError = false) { if (messageText && messageModal && closeMessageModalButton) { messageText.textContent = message; messageModal.classList.remove('opacity-0', 'invisible', 'bg-green-100', 'border-green-400', 'bg-red-100', 'border-red-400'); messageModal.classList.add('opacity-100', 'visible', 'translate-y-0'); messageText.className = 'text-sm font-medium'; if (isError) { messageText.classList.add('text-red-700'); messageModal.classList.add('bg-red-100', 'border-red-400'); } else { messageText.classList.add('text-green-700'); messageModal.classList.add('bg-green-100', 'border-green-400'); } setTimeout(() => { if(messageModal) { messageModal.classList.remove('opacity-100', 'visible', 'translate-y-0'); messageModal.classList.add('opacity-0', 'invisible'); } }, 4000); } }
        function calculateStrokesGained(esStart, esEnd, strokesTaken = 1, penalties = 0) { return parseFloat((esStart - esEnd - strokesTaken - penalties).toFixed(2)); }
        function categorizeShot(shotNumber, startLie, startDist, holePar) { startLie = startLie.toLowerCase(); if (shotNumber === 1) return (holePar === 3) ? "APP" : "OTT"; if (startLie === 'green') return "PUTT"; let startDistYds = startDist; if (startLie === 'fringe') startDistYds = startDist / 3; if (startDistYds <= 60) return "ARG"; return "APP"; }
        function updateCurrentShotDisplay() { if(currentShotNumberDisplay) currentShotNumberDisplay.textContent = appState.currentShotNumber; if(currentHoleNumberDisplayClone) currentHoleNumberDisplayClone.textContent = appState.currentHoleNumber; if(currentShotStartLieDisplay) currentShotStartLieDisplay.textContent = appState.currentShotStartLie.toUpperCase(); if(currentShotStartDistanceDisplay) { const unit = (appState.currentShotStartLie === 'green' || appState.currentShotStartLie === 'fringe') ? "ft" : "yds"; currentShotStartDistanceDisplay.textContent = `${appState.currentShotStartDistance.toFixed(1)} ${unit}`; } if(shotDataForm) shotDataForm.reset(); const endDistInput = document.getElementById('shotEndDistance'); if (endDistInput) endDistInput.placeholder = "Enter distance"; const clubUsedInput = document.getElementById('shotClubUsed'); if(clubUsedInput) clubUsedInput.focus(); }
        function startNewRound(event) { event.preventDefault(); const formData = new FormData(initialRoundSetupForm); appState.roundData = { userId: currentUserId, date: formData.get('roundDate'), courseName: formData.get('roundCourseName'), totalHolesToPlay: parseInt(formData.get('roundTotalHoles')), holes: [], totalScore: 0, totalSG: 0, totalSG_OTT: 0, totalSG_APP: 0, totalSG_ARG: 0, totalSG_PUTT: 0, tiger5_doubleBogeys_count: 0, tiger5_bogeyPar5s_count: 0, tiger5_bogeyUnder130_count: 0, tiger5_twoChips_count: 0, tiger5_threePutts_count: 0, tiger5_total_count: 0, createdAt: serverTimestamp() }; saveStateToLocalStorage(); restoreDataEntryUI(); }
        function startNewHole(event) { event.preventDefault(); const formData = new FormData(holeInfoForm); const par = parseInt(formData.get('holeParInput')); const length = parseInt(formData.get('holeLengthInput')); if (isNaN(par) || isNaN(length) || par < 3 || par > 5 || length < 50 || length > 800) { showMessage("Invalid Par (3-5) or Hole Length (50-800 yds).", true); return; } appState.currentHoleData = { holeNumber: appState.currentHoleNumber, par: par, length: length, shots: [], score: 0, penaltiesThisHole: 0, sgOTT: 0, sgAPP: 0, sgARG: 0, sgPUTT: 0, totalSG: 0, approachedFromUnder130: false, tiger5_doubleBogeyOccurred: false, tiger5_bogeyPar5Occurred: false, tiger5_bogeyUnder130Occurred: false, tiger5_twoChipsOccurred: false, tiger5_threePuttOccurred: false }; appState.currentShotNumber = 1; appState.currentShotStartLie = 'tee'; appState.currentShotStartDistance = length; appState.currentHoleTotalStrokes = 0; appState.currentHolePenalties = 0; saveStateToLocalStorage(); restoreDataEntryUI(); }
        function addShot(event) { event.preventDefault(); if (!appState.currentHoleData) { showMessage("Error: No current hole data.", true); return; } const formData = new FormData(shotDataForm); let endDist = parseFloat(formData.get('shotEndDistance')); const endLie = formData.get('shotEndLie').toLowerCase(); const clubUsed = formData.get('shotClubUsed'); const penaltiesThisShot = parseInt(formData.get('shotPenalties')) || 0; if (isNaN(endDist) || !endLie) { showMessage("Please enter valid End Distance and End Lie.", true); return; } let endDistForES = endDist; let startDistForES = appState.currentShotStartDistance; let esStart, esEnd; if (appState.currentShotNumber === 1) { esStart = getExpectedStrokes(appState.currentHoleData.length, 'tee', true, appState.currentHoleData.par, appState.currentHoleData.length); } else { esStart = getExpectedStrokes(startDistForES, appState.currentShotStartLie, false, appState.currentHoleData.par); } esEnd = getExpectedStrokes(endDistForES, endLie, false, appState.currentHoleData.par); if (endLie === 'green' && endDist === 0) { esEnd = 0; } const sgThisShot = calculateStrokesGained(esStart, esEnd, 1, penaltiesThisShot); const shotCategory = categorizeShot(appState.currentShotNumber, appState.currentShotStartLie, startDistForES, appState.currentHoleData.par); if (shotCategory === "APP" || (appState.currentShotNumber === 1 && appState.currentHoleData.par === 3)) { let approachStartDistYds = startDistForES; if (appState.currentShotNumber === 1 && appState.currentHoleData.par === 3) { approachStartDistYds = appState.currentHoleData.length; } else if (appState.currentShotStartLie === 'fringe'){ approachStartDistYds = startDistForES / 3; } if (approachStartDistYds <= 130) { appState.currentHoleData.approachedFromUnder130 = true; } } if (!appState.currentHoleData.tiger5_twoChipsOccurred && appState.currentHoleData.shots.length > 0) { const lastShot = appState.currentHoleData.shots[appState.currentHoleData.shots.length - 1]; let lastShotStartDistYds = lastShot.startDistance; if(lastShot.startLie === 'fringe' || lastShot.startLie === 'green') lastShotStartDistYds /= 3; if (lastShot.category === 'ARG' && lastShotStartDistYds <= 60 && lastShot.endLie !== 'green' && lastShot.endLie !== 'fringe' && shotCategory === 'ARG') { appState.currentHoleData.tiger5_twoChipsOccurred = true; } } const shotDetail = { shotNumber: appState.currentShotNumber, startLie: appState.currentShotStartLie, startDistance: appState.currentShotStartDistance, clubUsed: clubUsed, endLie: endLie, endDistance: endDist, penalties: penaltiesThisShot, sg: sgThisShot, category: shotCategory }; appState.currentHoleData.shots.push(shotDetail); appState.currentHoleTotalStrokes += (1 + penaltiesThisShot); appState.currentHolePenalties += penaltiesThisShot; appState.currentHoleData[`sg${shotCategory}`] = (appState.currentHoleData[`sg${shotCategory}`] || 0) + sgThisShot; if (endLie === 'green' && endDist === 0) { if(shotEntrySection) shotEntrySection.classList.add('hidden'); if(finishHoleButton) finishHoleButton.classList.remove('hidden'); showMessage(`Hole finished in ${appState.currentHoleTotalStrokes} strokes.`, false); } else { appState.currentShotNumber++; appState.currentShotStartLie = endLie; appState.currentShotStartDistance = endDist; updateCurrentShotDisplay(); } saveStateToLocalStorage(); }
        function finishHole() { if (!appState.currentHoleData) { showMessage("Error: No hole data to finish.", true); return; } appState.currentHoleData.score = appState.currentHoleTotalStrokes; appState.currentHoleData.totalSG = parseFloat(appState.currentHoleData.shots.reduce((sum, shot) => sum + shot.sg, 0).toFixed(2)); appState.currentHoleData.sgOTT = parseFloat((appState.currentHoleData.sgOTT || 0).toFixed(2)); appState.currentHoleData.sgAPP = parseFloat((appState.currentHoleData.sgAPP || 0).toFixed(2)); appState.currentHoleData.sgARG = parseFloat((appState.currentHoleData.sgARG || 0).toFixed(2)); appState.currentHoleData.sgPUTT = parseFloat((appState.currentHoleData.sgPUTT || 0).toFixed(2)); if (appState.currentHoleData.score >= appState.currentHoleData.par + 2) { appState.currentHoleData.tiger5_doubleBogeyOccurred = true; appState.roundData.tiger5_doubleBogeys_count++; } if (appState.currentHoleData.par === 5 && appState.currentHoleData.score >= 6) { appState.currentHoleData.tiger5_bogeyPar5Occurred = true; appState.roundData.tiger5_bogeyPar5s_count++; } if (appState.currentHoleData.approachedFromUnder130 && appState.currentHoleData.score >= appState.currentHoleData.par + 1) { appState.currentHoleData.tiger5_bogeyUnder130Occurred = true; appState.roundData.tiger5_bogeyUnder130_count++; } if (appState.currentHoleData.tiger5_twoChipsOccurred) { appState.roundData.tiger5_twoChips_count++; } const puttsOnThisHole = appState.currentHoleData.shots.filter(s => s.category === 'PUTT').length; if (puttsOnThisHole >= 3) { appState.currentHoleData.tiger5_threePuttOccurred = true; appState.roundData.tiger5_threePutts_count++; } appState.roundData.holes.push(appState.currentHoleData); if (appState.currentHoleNumber < appState.roundData.totalHolesToPlay) { appState.currentHoleNumber++; appState.currentHoleData = null; restoreDataEntryUI(); } else { if(holeSetupSection) holeSetupSection.classList.add('hidden'); if(shotEntrySection) shotEntrySection.classList.add('hidden'); if(finishHoleButton) finishHoleButton.classList.add('hidden'); if(finishRoundButton) finishRoundButton.classList.remove('hidden'); showMessage("All holes entered. Click 'Finish Round & Save'.", false); } saveStateToLocalStorage(); }
        async function finishRoundAndSave() { 
            if (!appState.roundData || appState.roundData.holes.length === 0) { showMessage("No round data to save.", true); return; }
            if(loadingIndicator) loadingIndicator.classList.remove('hidden');
            appState.roundData.totalScore = appState.roundData.holes.reduce((sum, hole) => sum + hole.score, 0);
            appState.roundData.totalSG_OTT = appState.roundData.holes.reduce((sum, hole) => sum + (hole.sgOTT || 0), 0);
            appState.roundData.totalSG_APP = appState.roundData.holes.reduce((sum, hole) => sum + (hole.sgAPP || 0), 0);
            appState.roundData.totalSG_ARG = appState.roundData.holes.reduce((sum, hole) => sum + (hole.sgARG || 0), 0);
            appState.roundData.totalSG_PUTT = appState.roundData.holes.reduce((sum, hole) => sum + (hole.sgPUTT || 0), 0);
            appState.roundData.totalSG = appState.roundData.totalSG_OTT + appState.roundData.totalSG_APP + appState.roundData.totalSG_ARG + appState.roundData.totalSG_PUTT;
            appState.roundData.tiger5_total_count = (appState.roundData.tiger5_doubleBogeys_count || 0) + (appState.roundData.tiger5_bogeyPar5s_count || 0) + (appState.roundData.tiger5_bogeyUnder130_count || 0) + (appState.roundData.tiger5_twoChips_count || 0) + (appState.roundData.tiger5_threePutts_count || 0);
            ['totalSG', 'totalSG_OTT', 'totalSG_APP', 'totalSG_ARG', 'totalSG_PUTT'].forEach(key => { appState.roundData[key] = parseFloat(appState.roundData[key].toFixed(2)); });
            
            const courseLayout = { courseName: appState.roundData.courseName, holes: appState.roundData.holes.map(h => ({ holeNumber: h.holeNumber, par: h.par, length: h.length })) };
            const courseDocId = appState.roundData.courseName.toLowerCase().replace(/\s+/g, '-');
            const courseDocRef = doc(db, `users/${currentUserId}/courses`, courseDocId);

            try {
                const mainRoundsCollectionPath = `artifacts/${firestorePathIdentifier}/users/${currentUserId}/golfRoundsShotByShot`;
                const roundDocRef = doc(collection(db, mainRoundsCollectionPath)); 
                const batch = writeBatch(db);
                const roundSummaryData = { ...appState.roundData };
                delete roundSummaryData.holes; 
                batch.set(roundDocRef, roundSummaryData);
                for (const hole of appState.roundData.holes) {
                    const holeDocRef = doc(db, `${mainRoundsCollectionPath}/${roundDocRef.id}/holes`, hole.holeNumber.toString());
                    const holeSummaryData = { ...hole }; delete holeSummaryData.shots; 
                    batch.set(holeDocRef, holeSummaryData);
                    for (const shot of hole.shots) {
                        const shotDocRef = doc(db, `${mainRoundsCollectionPath}/${roundDocRef.id}/holes/${hole.holeNumber}/shots`, shot.shotNumber.toString());
                        batch.set(shotDocRef, shot);
                    }
                }
                batch.set(courseDocRef, courseLayout, { merge: true }); 
                await batch.commit();
                showMessage("Round and course layout saved successfully!", false);
                clearStateFromLocalStorage();
                resetEntireAppUI();
                switchPage('dashboard');
            } catch (error) { showMessage("Error saving round: " + error.message, true); } 
            finally { if(loadingIndicator) { loadingIndicator.classList.add('hidden'); loadingIndicator.style.display = 'none'; } }
        }
        function resetEntireAppUI() { 
            appState.roundData = null; appState.currentHoleData = null;
            appState.currentHoleNumber = 1; appState.currentShotNumber = 1;
            appState.currentShotStartLie = 'tee'; appState.currentShotStartDistance = 0;
            appState.currentHoleTotalStrokes = 0; appState.currentHolePenalties = 0;
            if(initialRoundSetupForm) { initialRoundSetupForm.reset(); initialRoundSetupForm.classList.remove('hidden'); }
            if(holeSetupSection) holeSetupSection.classList.add('hidden');
            if(shotEntrySection) shotEntrySection.classList.add('hidden');
            if(finishRoundButton) finishRoundButton.classList.add('hidden');
            if(finishHoleButton) finishHoleButton.classList.add('hidden');
            if(holeInfoForm) holeInfoForm.reset();
            if(shotDataForm) shotDataForm.reset();
            if(currentHoleNumberDisplay) currentHoleNumberDisplay.textContent = appState.currentHoleNumber;
            const holeNumDispButton = document.getElementById('currentHoleNumberDisplayForButton');
            if(holeNumDispButton) holeNumDispButton.textContent = appState.currentHoleNumber;
            if(currentHoleNumberDisplayClone) currentHoleNumberDisplayClone.textContent = appState.currentHoleNumber;
        }
        function restoreDataEntryUI() {
            if (!appState.roundData) { resetEntireAppUI(); return; }
            if(initialRoundSetupForm) initialRoundSetupForm.classList.add('hidden');
            if (!appState.currentHoleData) { 
                if(holeSetupSection) holeSetupSection.classList.remove('hidden');
                if(shotEntrySection) shotEntrySection.classList.add('hidden');
                const holeNumInput = document.getElementById('holeNumberInput');
                if(holeNumInput) holeNumInput.value = appState.currentHoleNumber;
                if(currentHoleNumberDisplay) currentHoleNumberDisplay.textContent = appState.currentHoleNumber;
                const holeNumDispButton = document.getElementById('currentHoleNumberDisplayForButton');
                if(holeNumDispButton) holeNumDispButton.textContent = appState.currentHoleNumber;
                
                const courseName = appState.roundData.courseName;
                if (appState.knownCourses[courseName]) {
                    const holeInfo = appState.knownCourses[courseName].holes.find(h => h.holeNumber === appState.currentHoleNumber);
                    if (holeInfo) {
                        document.getElementById('holeParInput').value = holeInfo.par;
                        document.getElementById('holeLengthInput').value = holeInfo.length;
                    }
                } else {
                    document.getElementById('holeParInput').value = '';
                    document.getElementById('holeLengthInput').value = '';
                }
                document.getElementById('holeParInput').focus();
            } else { 
                if(holeSetupSection) holeSetupSection.classList.add('hidden');
                if(shotEntrySection) shotEntrySection.classList.remove('hidden');
                updateCurrentShotDisplay();
            }
        }

        // --- DASHBOARD AND CHARTING FUNCTIONS ---
        function destroyCharts() { Object.values(chartInstances).forEach(chart => { if (chart) chart.destroy(); }); chartInstances = {}; }
        
        function renderPerformanceTrendChart(rounds) { 
            const ctx = document.getElementById('performanceTrendChart'); if (!ctx) return;
            const labels = rounds.map(r => r.date); const sgData = rounds.map(r => r.totalSG);
            chartInstances.performanceTrend = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: 'Total Strokes Gained per Round', data: sgData, borderColor: '#2563eb', backgroundColor: 'rgba(37, 99, 235, 0.1)', fill: true, tension: 0.1, borderWidth: 2, pointBackgroundColor: '#2563eb' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false, grid: { color: '#e2e8f0' } }, x: { grid: { display: false } } }, plugins: { legend: { display: false }, title: { display: true, text: 'Overall Performance Trend', font: { size: 16, weight: '600' }, color: '#1e293b', padding: { bottom: 20 } } } } });
        }
        
        function renderSgBreakdownChart(rounds) { 
            const ctx = document.getElementById('sgBreakdownChart'); if (!ctx || rounds.length === 0) return; const numRounds = rounds.length;
            const avgSG_OTT = rounds.reduce((sum, r) => sum + (r.totalSG_OTT || 0), 0) / numRounds;
            const avgSG_APP = rounds.reduce((sum, r) => sum + (r.totalSG_APP || 0), 0) / numRounds;
            const avgSG_ARG = rounds.reduce((sum, r) => sum + (r.totalSG_ARG || 0), 0) / numRounds;
            const avgSG_PUTT = rounds.reduce((sum, r) => sum + (r.totalSG_PUTT || 0), 0) / numRounds;
            chartInstances.sgBreakdown = new Chart(ctx, { type: 'bar', data: { labels: ['Off the Tee', 'Approach', 'Around Green', 'Putting'], datasets: [{ label: 'Average Strokes Gained', data: [avgSG_OTT, avgSG_APP, avgSG_ARG, avgSG_PUTT], backgroundColor: (context) => { const value = context.dataset.data[context.dataIndex]; return value >= 0 ? 'rgba(5, 150, 105, 0.7)' : 'rgba(220, 38, 38, 0.7)'; }, borderColor: (context) => { const value = context.dataset.data[context.dataIndex]; return value >= 0 ? 'rgba(5, 150, 105, 1)' : 'rgba(220, 38, 38, 1)'; }, borderWidth: 1 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { grid: { color: '#e2e8f0' }, title: { display: true, text: 'Strokes Gained' } }, y: { grid: { display: false } } }, plugins: { legend: { display: false }, title: { display: true, text: 'Average SG by Category', font: { size: 16, weight: '600' }, color: '#1e293b', padding: { bottom: 20 } } } } });
        }
        
        function renderTiger5Chart(rounds) { 
            const ctx = document.getElementById('tiger5Chart'); if (!ctx || rounds.length === 0) return; const numRounds = rounds.length;
            const avgT5Double = rounds.reduce((sum,r) => sum + (r.tiger5_doubleBogeys_count || 0), 0) / numRounds;
            const avgT5Par5 = rounds.reduce((sum,r) => sum + (r.tiger5_bogeyPar5s_count || 0), 0) / numRounds;
            const avgT5Under130 = rounds.reduce((sum,r) => sum + (r.tiger5_bogeyUnder130_count || 0), 0) / numRounds;
            const avgT5TwoChip = rounds.reduce((sum,r) => sum + (r.tiger5_twoChips_count || 0), 0) / numRounds;
            const avgT5ThreePutt = rounds.reduce((sum,r) => sum + (r.tiger5_threePutts_count || 0), 0) / numRounds;
            chartInstances.tiger5 = new Chart(ctx, { type: 'bar', data: { labels: ['Dbl Bogey+', 'Bogey on P5', 'Bogey <130', '2+ Chips', '3-Putts+'], datasets: [{ label: 'Average Occurrences per Round', data: [avgT5Double, avgT5Par5, avgT5Under130, avgT5TwoChip, avgT5ThreePutt], backgroundColor: 'rgba(217, 119, 6, 0.7)', borderColor: 'rgba(217, 119, 6, 1)', borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: '#e2e8f0' }, title: { display: true, text: 'Avg per Round' } }, x: { grid: { display: false } } }, plugins: { legend: { display: false }, title: { display: true, text: '"Tiger 5" Mistake Frequency', font: { size: 16, weight: '600' }, color: '#1e293b', padding: { bottom: 20 } } } } });
        }
        
        function displayRounds(roundsData) { 
            if (!roundsTableBody) return; 
            roundsTableBody.innerHTML = '';
             if (roundsData.length === 0) {
                roundsTableBody.innerHTML = '<tr><td colspan="15" class="text-center py-4">No rounds recorded yet.</td></tr>'; 
                return;
            }
            roundsData.forEach(round => {
                const row = roundsTableBody.insertRow(); row.className = 'hover:bg-slate-50 transition-colors';
                const sgTotal = round.totalSG !== undefined ? round.totalSG.toFixed(2) : 'N/A';
                const sgOTT = round.totalSG_OTT !== undefined ? round.totalSG_OTT.toFixed(2) : 'N/A';
                const sgAPP = round.totalSG_APP !== undefined ? round.totalSG_APP.toFixed(2) : 'N/A';
                const sgARG = round.totalSG_ARG !== undefined ? round.totalSG_ARG.toFixed(2) : 'N/A';
                const sgPUTT = round.totalSG_PUTT !== undefined ? round.totalSG_PUTT.toFixed(2) : 'N/A';
                const t5Double = round.tiger5_doubleBogeys_count !== undefined ? round.tiger5_doubleBogeys_count : 0;
                const t5Par5 = round.tiger5_bogeyPar5s_count !== undefined ? round.tiger5_bogeyPar5s_count : 0;
                const t5Under130 = round.tiger5_bogeyUnder130_count !== undefined ? round.tiger5_bogeyUnder130_count : 0;
                const t5TwoChip = round.tiger5_twoChips_count !== undefined ? round.tiger5_twoChips_count : 0;
                const t5ThreePutt = round.tiger5_threePutts_count !== undefined ? round.tiger5_threePutts_count : 0;
                const t5Total = round.tiger5_total_count !== undefined ? round.tiger5_total_count : 0;
                row.innerHTML = `<td class="px-3 py-3.5 border-b border-slate-200 text-xs whitespace-nowrap">${round.date}</td><td class="px-3 py-3.5 border-b border-slate-200 text-xs truncate" style="max-width: 120px;">${round.courseName}</td><td class="px-3 py-3.5 border-b border-slate-200 text-xs text-center">${round.totalScore}</td><td class="px-3 py-3.5 border-b border-slate-200 text-xs text-center ${round.totalSG >= 0 ? 'text-green-600' : 'text-red-600'}">${sgTotal}</td><td class="px-3 py-3.5 border-b border-slate-200 text-xs text-center ${round.totalSG_OTT >= 0 ? 'text-green-600' : 'text-red-600'}">${sgOTT}</td><td class="px-3 py-3.5 border-b border-slate-200 text-xs text-center ${round.totalSG_APP >= 0 ? 'text-green-600' : 'text-red-600'}">${sgAPP}</td><td class="px-3 py-3.5 border-b border-slate-200 text-xs text-center ${round.totalSG_ARG >= 0 ? 'text-green-600' : 'text-red-600'}">${sgARG}</td><td class="px-3 py-3.5 border-b border-slate-200 text-xs text-center ${round.totalSG_PUTT >= 0 ? 'text-green-600' : 'text-red-600'}">${sgPUTT}</td><td class="px-2 py-3.5 border-b border-slate-200 text-xs text-center">${t5Double}</td><td class="px-2 py-3.5 border-b border-slate-200 text-xs text-center">${t5Par5}</td><td class="px-2 py-3.5 border-b border-slate-200 text-xs text-center">${t5Under130}</td><td class="px-2 py-3.5 border-b border-slate-200 text-xs text-center">${t5TwoChip}</td><td class="px-2 py-3.5 border-b border-slate-200 text-xs text-center">${t5ThreePutt}</td><td class="px-2 py-3.5 border-b border-slate-200 text-xs text-center font-semibold text-red-700">${t5Total}</td><td class="px-3 py-3.5 border-b border-slate-200 text-xs text-center"><button data-id="${round.id}" class="delete-round-btn text-slate-400 hover:text-red-600 p-1 rounded-full hover:bg-red-100"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg></button></td>`;
            });
            document.querySelectorAll('.delete-round-btn').forEach(button => {
                button.addEventListener('click', async (event) => {
                    const roundId = event.currentTarget.dataset.id;
                    if (!confirm(`Are you sure you want to delete this round data? This cannot be undone.`)) return;
                    try {
                        if(loadingIndicator) loadingIndicator.classList.remove('hidden');
                        const mainRoundsCollectionPath = `artifacts/${firestorePathIdentifier}/users/${currentUserId}/golfRoundsShotByShot`;
                        const holesCollectionRef = collection(db, `${mainRoundsCollectionPath}/${roundId}/holes`);
                        const holesSnapshot = await getDocs(holesCollectionRef);
                        const batch = writeBatch(db); 
                        for (const holeDoc of holesSnapshot.docs) {
                            const shotsCollectionRef = collection(db, `${mainRoundsCollectionPath}/${roundId}/holes/${holeDoc.id}/shots`);
                            const shotsSnapshot = await getDocs(shotsCollectionRef);
                            shotsSnapshot.forEach(shotDoc => { batch.delete(shotDoc.ref); });
                            batch.delete(holeDoc.ref); 
                        }
                        batch.delete(doc(db, mainRoundsCollectionPath, roundId)); 
                        await batch.commit();
                        showMessage("Round and associated data deleted successfully.", false);
                        fetchAndDisplayDashboardData(); 
                    } catch (error) { showMessage("Error deleting round: " + error.message, true);
                    } finally { 
                        if(loadingIndicator) { loadingIndicator.classList.add('hidden'); loadingIndicator.style.display = 'none'; }
                    }
                });
            });
        }
        function calculateAndDisplayOverallSummary(rounds) { 
            if (!statsSummary || rounds.length === 0) { if (statsSummary) statsSummary.innerHTML = '<p class="text-center text-slate-500">No data for summary.</p>'; return; }
            const numRounds = rounds.length;
            const avgScore = rounds.reduce((sum, r) => sum + r.totalScore, 0) / numRounds;
            const avgSG = rounds.reduce((sum, r) => sum + (r.totalSG || 0), 0) / numRounds;
            const avgSG_OTT = rounds.reduce((sum, r) => sum + (r.totalSG_OTT || 0), 0) / numRounds;
            const avgSG_APP = rounds.reduce((sum, r) => sum + (r.totalSG_APP || 0), 0) / numRounds;
            const avgSG_ARG = rounds.reduce((sum, r) => sum + (r.totalSG_ARG || 0), 0) / numRounds;
            const avgSG_PUTT = rounds.reduce((sum, r) => sum + (r.totalSG_PUTT || 0), 0) / numRounds;
            const avgT5Double = rounds.reduce((sum,r) => sum + (r.tiger5_doubleBogeys_count || 0), 0) / numRounds;
            const avgT5Par5 = rounds.reduce((sum,r) => sum + (r.tiger5_bogeyPar5s_count || 0), 0) / numRounds;
            const avgT5Under130 = rounds.reduce((sum,r) => sum + (r.tiger5_bogeyUnder130_count || 0), 0) / numRounds;
            const avgT5TwoChip = rounds.reduce((sum,r) => sum + (r.tiger5_twoChips_count || 0), 0) / numRounds;
            const avgT5ThreePutt = rounds.reduce((sum,r) => sum + (r.tiger5_threePutts_count || 0), 0) / numRounds;
            const avgT5Total = rounds.reduce((sum,r) => sum + (r.tiger5_total_count || 0), 0) / numRounds;
            statsSummary.innerHTML = `<div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 text-sm mb-8"><div class="stat-card"><span class="stat-card-label">Avg Score</span> <span class="stat-card-value text-blue-600">${avgScore.toFixed(1)}</span></div><div class="stat-card"><span class="stat-card-label">Avg SG Total</span> <span class="stat-card-value ${avgSG >= 0 ? 'text-green-600' : 'text-red-600'}">${avgSG.toFixed(2)}</span></div><div class="stat-card"><span class="stat-card-label">Avg SG:OTT</span> <span class="stat-card-value ${avgSG_OTT >= 0 ? 'text-green-600' : 'text-red-600'}">${avgSG_OTT.toFixed(2)}</span></div><div class="stat-card"><span class="stat-card-label">Avg SG:APP</span> <span class="stat-card-value ${avgSG_APP >= 0 ? 'text-green-600' : 'text-red-600'}">${avgSG_APP.toFixed(2)}</span></div><div class="stat-card"><span class="stat-card-label">Avg SG:ARG</span> <span class="stat-card-value ${avgSG_ARG >= 0 ? 'text-green-600' : 'text-red-600'}">${avgSG_ARG.toFixed(2)}</span></div><div class="stat-card"><span class="stat-card-label">Avg SG:PUTT</span> <span class="stat-card-value ${avgSG_PUTT >= 0 ? 'text-green-600' : 'text-red-600'}">${avgSG_PUTT.toFixed(2)}</span></div></div><h4 class="form-section-title mt-10">"Tiger 5" Averages <span class="text-sm font-normal text-slate-500">(Mistakes per Round)</span></h4><div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-3 gap-4 text-sm"><div class="stat-card bg-amber-50 border border-amber-200"><span class="stat-card-label text-amber-800">Avg Dbl Bogey+</span> <span class="stat-card-value text-amber-900">${avgT5Double.toFixed(1)}</span></div><div class="stat-card bg-amber-50 border border-amber-200"><span class="stat-card-label text-amber-800">Avg Bogey on P5</span> <span class="stat-card-value text-amber-900">${avgT5Par5.toFixed(1)}</span></div><div class="stat-card bg-amber-50 border border-amber-200"><span class="stat-card-label text-amber-800">Avg Bogey &lt;130</span> <span class="stat-card-value text-amber-900">${avgT5Under130.toFixed(1)}</span></div><div class="stat-card bg-amber-50 border border-amber-200"><span class="stat-card-label text-amber-800">Avg 2+ Chips</span> <span class="stat-card-value text-amber-900">${avgT5TwoChip.toFixed(1)}</span></div><div class="stat-card bg-amber-50 border border-amber-200"><span class="stat-card-label text-amber-800">Avg 3-Putts+</span> <span class="stat-card-value text-amber-900">${avgT5ThreePutt.toFixed(1)}</span></div><div class="stat-card bg-red-100 border border-red-200"><span class="stat-card-label text-red-800">Avg Tiger 5 Total</span> <span class="stat-card-value text-red-900">${avgT5Total.toFixed(1)}</span></div></div>`;
        }
        
        async function fetchAndDisplayDashboardData() { 
            if (!currentUserId || !db) { if(loadingIndicator) { loadingIndicator.classList.add('hidden'); loadingIndicator.style.display = 'none';} return; }
            if(loadingIndicator) { loadingIndicator.classList.remove('hidden'); loadingIndicator.style.display = 'flex'; }
            
            const collectionPath = `artifacts/${firestorePathIdentifier}/users/${currentUserId}/golfRoundsShotByShot`;
            const q = query(collection(db, collectionPath));
            try {
                const querySnapshot = await getDocs(q);
                const rounds = [];
                querySnapshot.forEach((doc) => { rounds.push({ id: doc.id, ...doc.data() }); });
                const sortedRounds = rounds.sort((a,b) => new Date(a.date) - new Date(b.date)); 
                
                destroyCharts(); 
                displayRounds(rounds); 
                calculateAndDisplayOverallSummary(rounds); 
                renderPerformanceTrendChart(sortedRounds); 
                renderSgBreakdownChart(rounds); 
                renderTiger5Chart(rounds);
            } catch (error) { showMessage("Error fetching dashboard data: " + error.message, true); displayRounds([]); calculateAndDisplayOverallSummary([]);
            } finally { if(loadingIndicator) { loadingIndicator.classList.add('hidden'); loadingIndicator.style.display = 'none';} }
        }

        function switchPage(page) {
            if (page === 'dashboard') {
                pageDataEntry.classList.add('hidden'); pageDashboard.classList.remove('hidden');
                navLinkDataEntry.classList.remove('bg-white', 'text-blue-600', 'font-semibold', 'shadow');
                navLinkDataEntry.classList.add('text-slate-600');
                navLinkDashboard.classList.add('bg-white', 'text-blue-600', 'font-semibold', 'shadow');
                navLinkDashboard.classList.remove('text-slate-600');
                fetchAndDisplayDashboardData();
            } else { 
                destroyCharts(); 
                pageDashboard.classList.add('hidden'); pageDataEntry.classList.remove('hidden');
                navLinkDashboard.classList.remove('bg-white', 'text-blue-600', 'font-semibold', 'shadow');
                navLinkDashboard.classList.add('text-slate-600');
                navLinkDataEntry.classList.add('bg-white', 'text-blue-600', 'font-semibold', 'shadow');
                navLinkDataEntry.classList.remove('text-slate-600');
                restoreDataEntryUI();
            }
        }

        async function init() {
            try {
                app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app); analytics = getAnalytics(app); 
                
                navLinkDashboard.addEventListener('click', () => switchPage('dashboard'));
                navLinkDataEntry.addEventListener('click', () => switchPage('data-entry'));
                resumeSessionButton.addEventListener('click', () => {
                    resumeSessionModal.classList.add('hidden');
                    restoreDataEntryUI();
                    switchPage('data-entry');
                });
                discardSessionButton.addEventListener('click', () => {
                    resumeSessionModal.classList.add('hidden');
                    clearStateFromLocalStorage();
                    resetEntireAppUI();
                    switchPage('dashboard');
                });

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        if(userIdDisplay) userIdDisplay.textContent = `User ID: ${currentUserId.substring(0,8)}...`;
                        
                        initialRoundSetupForm.addEventListener('submit', startNewRound);
                        holeInfoForm.addEventListener('submit', startNewHole);
                        shotDataForm.addEventListener('submit', addShot); 
                        finishHoleButton.addEventListener('click', finishHole);
                        finishRoundButton.addEventListener('click', finishRoundAndSave);
                        
                        if (loadStateFromLocalStorage()) {
                            resumeSessionModal.classList.remove('hidden');
                        } else {
                            switchPage('dashboard'); 
                        }
                        
                    } else {
                        currentUserId = null;
                        if(userIdDisplay) userIdDisplay.textContent = "Not signed in";
                        resetEntireAppUI(); 
                        if(roundsTableBody) roundsTableBody.innerHTML = '<tr><td colspan="15" class="text-center py-4">Please sign in.</td></tr>';
                        if(statsSummary) statsSummary.innerHTML = '<p class="text-center text-slate-500">Please sign in.</p>';
                        if(loadingIndicator) { loadingIndicator.classList.remove('hidden'); loadingIndicator.style.display = 'flex'; }
                        try { await signInAnonymously(auth); } 
                        catch (error_1) { showMessage("Could not sign in. Data features disabled.", true); } 
                        finally { if(loadingIndicator) {loadingIndicator.classList.add('hidden'); loadingIndicator.style.display = 'none';} }
                    }
                });
            } catch (error) {
                showMessage("Error initializing application: " + error.message, true);
            }
        }
        
        document.addEventListener('DOMContentLoaded', init);
    </script>
    <style> 
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; /* Slate 100 bg */ }
        .app-brand-text { font-family: 'Inter', sans-serif; font-weight: 900; }
        .app-title-text { font-family: 'Inter', sans-serif; font-weight: 700; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -2px rgba(0,0,0,0.05); padding: 1.5rem; border: 1px solid #e2e8f0; }
        .form-section-title { font-size: 1.25rem; font-weight: 700; color: #1e293b; margin-bottom: 1.25rem; padding-bottom: 0.75rem; border-bottom: 1px solid #e2e8f0; }
        label { display: block; margin-bottom: 0.375rem; font-weight: 500; color: #475569; font-size: 0.875rem; }
        input[type="text"], input[type="number"], input[type="date"], select { 
            width: 100%; padding: 0.625rem 0.875rem; 
            border: 1px solid #cbd5e1; border-radius: 0.5rem; 
            box-shadow: inset 0 1px 2px 0 rgb(0 0 0 / 0.05);
            font-size: 0.875rem; color: #334155; 
            background-color: #f8fafc; transition: border-color 0.2s, box-shadow 0.2s;
        }
        input:focus, select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.25); }
        .btn { 
            display: inline-flex; align-items: center; justify-content: center;
            font-weight: 600; border-radius: 0.5rem; padding: 0.75rem 1.5rem;
            font-size: 0.875rem; line-height: 1.25rem;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06);
            border: 1px solid transparent; cursor: pointer;
        }
        .btn-primary { background-color: #2563eb; color: white; }
        .btn-primary:hover { background-color: #1d4ed8; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.1);}
        .btn-green { background-color: #059669; color: white; }
        .btn-green:hover { background-color: #047857; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.1);}
        .btn-red { background-color: #dc2626; color: white; }
        .btn-red:hover { background-color: #b91c1c; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.1);}
        .btn-indigo { background-color: #4f46e5; color: white; }
        .btn-indigo:hover { background-color: #4338ca; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.1);}
        .btn-muted { background-color: #e2e8f0; color: #475569; }
        .btn-muted:hover { background-color: #cbd5e1; }

        #loadingIndicator, #resumeSessionModal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: rgba(241, 245, 249, 0.8); 
            display: flex; 
            justify-content: center; align-items: center; z-index: 9999; 
            backdrop-filter: blur(3px);
        }
        #loadingIndicator.hidden, #resumeSessionModal.hidden { display: none !important; }
        .spinner { border: 5px solid rgba(0,0,0,0.1); width: 50px; height: 50px; border-radius: 50%; border-left-color: #2563eb; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #messageModal { 
            position: fixed; top: 1.5rem; left: 50%; transform: translateX(-50%) translateY(-20px);
            z-index: 10000; border-radius: 0.5rem;
            padding: 1rem 1.5rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
            border-width: 1px;
        }
        #messageModal.visible { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(0); }

        .table-responsive-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; border: 1px solid #e2e8f0; border-radius: 0.5rem; }
        table th { background-color: #f8fafc; color: #475569; font-weight: 600; text-align: left;}
        table th, table td { white-space: nowrap; padding: 0.75rem 1rem; text-align: left; }
        table tbody tr:last-child td { border-bottom: none; }
        .stat-card { background-color: #ffffff; padding: 1rem; border-radius: 0.75rem; border: 1px solid #e2e8f0; box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05); }
        .stat-card-label { display: block; font-size: 0.875rem; font-weight: 500; color: #64748b; margin-bottom: 0.25rem; }
        .stat-card-value { display: block; font-size: 1.75rem; font-weight: 700; }
        .tiger5-header { background-color: #fef2f2 !important; color: #b91c1c !important; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen antialiased text-slate-800">
    <div id="loadingIndicator" class="hidden"> 
        <div class="spinner"></div>
    </div>
    <div id="messageModal" class="opacity-0 invisible fixed"> 
        <div class="flex items-center justify-between">
            <p id="messageText" class="text-sm font-medium"></p>
            <button id="closeMessageModalButton" class="text-slate-500 hover:text-slate-700 ml-4 -mr-1 p-1 rounded-full hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-400">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
            </button>
        </div>
    </div>
    <div id="resumeSessionModal" class="hidden">
        <div class="fixed inset-0 bg-slate-900 bg-opacity-30"></div>
        <div class="fixed inset-0 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
                <h3 class="text-lg font-semibold text-slate-800">In-Progress Round Found</h3>
                <p class="text-sm text-slate-500 mt-2 mb-6">You have an unfinished round saved. Would you like to resume where you left off, or discard it?</p>
                <div class="flex justify-center space-x-4">
                    <button id="discardSessionButton" class="btn btn-muted">Discard & Start New</button>
                    <button id="resumeSessionButton" class="btn btn-primary">Resume Session</button>
                </div>
            </div>
        </div>
    </div>


    <div class="container mx-auto max-w-7xl py-8 px-4">
        <header class="mb-8 text-center">
            <div class="flex items-center justify-center space-x-2 mb-2">
                <span class="app-brand-text text-5xl md:text-6xl text-slate-700">P</span>
                <div class="relative text-5xl md:text-6xl app-brand-text">
                    <span class="text-slate-400 transform -rotate-12 inline-block origin-center" style="font-size: 0.9em; margin-left: -0.25em; margin-right: -0.25em;">/</span>
                    <span class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-blue-600 text-4xl md:text-5xl" style="font-weight: 800;">%</span>
                </div>
                <span class="app-brand-text text-5xl md:text-6xl text-slate-700">P</span>
            </div>
            <h1 id="appTitle" class="app-title-text text-2xl md:text-3xl font-bold text-slate-800">Play the Percentage Golf</h1>
            <p id="userIdDisplay" class="text-xs text-slate-400 mt-3">User ID: Loading...</p>
        </header>

        <!-- Navigation -->
        <nav class="mb-8 flex justify-center">
            <div class="inline-flex rounded-lg bg-slate-200 p-1 space-x-1">
                 <button id="navLinkDashboard" class="px-5 py-2 text-sm font-semibold rounded-md transition-colors bg-white text-blue-600 shadow">Dashboard</button>
                 <button id="navLinkDataEntry" class="px-5 py-2 text-sm font-medium text-slate-600 rounded-md transition-colors">Data Entry</button>
            </div>
        </nav>


        <!-- Page Content -->
        <main>
            <!-- Dashboard Page -->
            <div id="pageDashboard">
                <section id="statsSummarySection" class="card">
                     <h2 class="form-section-title">Performance Summary</h2>
                     <div id="statsSummary">
                        <p class="text-center text-slate-500 py-4">Loading summary...</p>
                     </div>
                </section>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
                    <section class="card">
                        <div class="h-80"><canvas id="performanceTrendChart"></canvas></div>
                    </section>
                     <section class="card">
                        <div class="h-80"><canvas id="sgBreakdownChart"></canvas></div>
                    </section>
                </div>
                <section class="card mt-8">
                     <div class="h-80"><canvas id="tiger5Chart"></canvas></div>
                </section>


                <section class="card mt-8">
                    <h2 class="form-section-title">Recorded Rounds</h2>
                    <div class="table-responsive-wrapper">
                        <table class="min-w-full divide-y divide-slate-200 text-sm">
                            <thead class="bg-slate-100">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Date</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Course</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Score</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">SG Total</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">SG:OTT</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">SG:APP</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">SG:ARG</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">SG:PUTT</th>
                                    <th class="px-2 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider" title="Double Bogeys or Worse">Dbl+</th>
                                    <th class="px-2 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider" title="Bogeys on Par 5s">Bog P5</th>
                                    <th class="px-2 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider" title="Bogeys from <130yds Approach">Bog &lt;130</th>
                                    <th class="px-2 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider" title="2+ Chips to Green">2+Chp</th>
                                    <th class="px-2 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider" title="3+ Putts">3+Putt</th>
                                    <th class="px-2 py-3 text-left text-xs font-semibold text-red-700 bg-red-50 uppercase tracking-wider">T5 Total</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="roundsTableBody" class="bg-white divide-y divide-slate-200"></tbody>
                        </table>
                    </div>
                </section>
            </div>

            <!-- Data Entry Page -->
            <div id="pageDataEntry" class="hidden">
                 <div id="workflowContainer">
                    <form id="initialRoundSetupForm" class="card">
                        <h2 class="form-section-title">1. Start New Round</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-4">
                            <div>
                                <label for="roundCourseName">Course Name:</label>
                                <input type="text" id="roundCourseName" name="roundCourseName" required placeholder="e.g., Pebble Beach" list="course-list">
                                <datalist id="course-list"></datalist>
                            </div>
                            <div><label for="roundDate">Date:</label><input type="date" id="roundDate" name="roundDate" required></div>
                            <div><label for="roundTotalHoles">Holes to Play:</label>
                                <select id="roundTotalHoles" name="roundTotalHoles">
                                    <option value="18">18 Holes</option>
                                    <option value="9">9 Holes</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary w-full mt-8">Continue to Hole Setup</button>
                    </form>

                    <section id="holeSetupSection" class="card hidden">
                        <h2 class="form-section-title">2. Hole <span id="currentHoleNumberDisplay" class="text-blue-600">1</span> Setup</h2>
                        <form id="holeInfoForm">
                            <input type="hidden" id="holeNumberInput" name="holeNumberInput">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div><label for="holeParInput">Par:</label><input type="number" id="holeParInput" name="holeParInput" min="3" max="5" required placeholder="3, 4, or 5"></div>
                                <div><label for="holeLengthInput">Hole Length (yds):</label><input type="number" id="holeLengthInput" name="holeLengthInput" min="50" max="800" required placeholder="e.g., 420"></div>
                            </div>
                            <button type="submit" class="btn btn-green w-full">Start Shots for Hole <span id="currentHoleNumberDisplayForButton">1</span></button>
                        </form>
                    </section>

                    <section id="shotEntrySection" class="card hidden">
                        <h2 class="form-section-title">3. Hole <span id="currentHoleNumberDisplayClone" class="text-blue-600"></span> - Shot <span id="currentShotNumberDisplay" class="text-blue-600">1</span></h2>
                        <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-md text-sm">
                            <p><strong>Starting from:</strong> <span id="currentShotStartLieDisplay" class="font-semibold text-blue-700">TEE</span> at <span id="currentShotStartDistanceDisplay" class="font-semibold text-blue-700">0 yds</span></p>
                        </div>
                        <form id="shotDataForm">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 mb-6">
                                <div><label for="shotClubUsed">Club Used (Optional):</label><input type="text" id="shotClubUsed" name="shotClubUsed" placeholder="e.g., Driver, 7 Iron"></div>
                                <div><label for="shotPenalties">Penalty Strokes (this shot):</label><input type="number" id="shotPenalties" name="shotPenalties" min="0" value="0"></div>
                                 <div><label for="shotEndLie">End Lie:</label>
                                    <select id="shotEndLie" name="shotEndLie" required>
                                        <option value="fairway">Fairway</option>
                                        <option value="rough">Rough</option>
                                        <option value="fairwayBunker">Fairway Bunker</option>
                                        <option value="greensideBunker">Greenside Bunker</option>
                                        <option value="recovery">Recovery (Trees, etc.)</option>
                                        <option value="green">Green</option>
                                        <option value="fringe">Fringe</option>
                                        <option value="penalty">Penalty Area</option>
                                        <option value="tee">Tee (e.g. after penalty)</option> 
                                    </select>
                                </div>
                                <div>
                                    <label for="shotEndDistance">End Distance to Hole:</label>
                                    <input type="number" id="shotEndDistance" name="shotEndDistance" min="0" required placeholder="Enter distance">
                                    <p class="text-xs text-slate-500 mt-1">Enter in FEET if End Lie is Green/Fringe, otherwise YARDS.</p>
                                </div>
                            </div>
                            <button id="addShotButton" type="submit" class="btn btn-indigo w-full">Add Shot & Update</button>
                        </form>
                    </section>

                    <div class="mt-8 flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0 sm:space-x-4">
                        <button id="finishHoleButton" type="button" class="btn btn-green hidden w-full sm:w-auto">Finish Hole & Proceed to Next</button>
                        <button id="finishRoundButton" class="btn btn-red hidden w-full sm:w-auto">Finish Round & Save All Data</button>
                    </div>
                </div>
            </div>
        </main>
        
         <footer class="text-center text-sm text-slate-500 mt-16 py-8 border-t border-slate-200">
            Play the Percentage Golf - &copy; 2025
        </footer>
    </div>
</body>
</html>
